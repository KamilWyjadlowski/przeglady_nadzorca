<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Firmy</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <div class="container">
      <div class="topbar">
        <div class="brand">
          <div class="brand-title">Nadzorca przeglądów <span class="brand-version">{{ app_version }}</span></div>
        </div>
        <div class="user-panel">
          <a class="user-name user-link" href="{{ url_for('profile') }}">
            Zalogowany jako: <strong>{{ current_user.username if current_user else "-" }}</strong>
          </a>
          <form method="POST" action="{{ url_for('logout') }}" class="logout-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit" class="btn btn-ghost">Wyloguj</button>
          </form>
        </div>
      </div>

      <div class="nav-split">
        <div class="nav-left">
          <a class="nav-pill" href="{{ url_for('index') }}">Przeglądy</a>
          {% if current_user and current_user.role == "admin" %}
          <details class="app-nav-dropdown">
            <summary class="nav-pill">Admin</summary>
            <div class="app-nav-menu">
              <a class="app-nav-menu-link" href="{{ url_for('admin_properties') }}">Panel nieruchomości</a>
              <a class="app-nav-menu-link" href="{{ url_for('admin_users') }}">Użytkownicy</a>
              <a class="app-nav-menu-link" href="{{ url_for('admin_notifications') }}">Powiadomienia</a>
            </div>
          </details>
          {% endif %}
        </div>
        <div class="nav-right">
          <a class="nav-pill is-active" href="{{ url_for('firm_index') }}">Firmy</a>
        </div>
      </div>

      <div class="page-header">
        <h2>Firmy</h2>
      </div>

      <form method="GET" class="firm-toolbar">
        <div class="firm-search">
          <input
            type="text"
            name="q"
            value="{{ q }}"
            placeholder="Szukaj firmy, telefonu, maila, nieruchomości, zakresu"
          />
        </div>
        <div class="firm-filter">
          <select name="property" onchange="this.form.submit()">
            <option value="">Nieruchomość (wszystkie)</option>
            {% for p in used_properties %}
            <option value="{{ p }}" {% if p == selected_property %}selected{% endif %}>{{ p | format_property }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="firm-filter">
          <select name="scope" onchange="this.form.submit()">
            <option value="">Zakres (wszystkie)</option>
            {% for s in used_scopes %}
            <option value="{{ s }}" {% if s == selected_scope %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </div>
        <button type="submit" class="btn btn-primary">Szukaj</button>
        {% if q or selected_property or selected_scope %}
        <a href="{{ url_for('firm_index') }}" class="btn btn-ghost">Wyczyść</a>
        {% endif %}
      </form>

      <div class="firm-list">
        {% for firm in firms %}
        <div
          class="firm-row"
          data-href="{{ url_for('firm_detail', company=firm.name) }}"
          role="link"
          tabindex="0"
          aria-label="Firma {{ firm.name }}"
        >
          <div class="firm-row-content">
            <div class="firm-row-left">
              <div class="firm-row-name">{{ firm.name }}</div>
            </div>
            <div class="firm-row-right">
              <div class="firm-row-contact">
                {% if firm.primary_email %}
                <a class="firm-inline-link" href="mailto:{{ firm.primary_email }}">{{ firm.primary_email }}</a>
                {% elif firm.primary_phone %}
                <span>{{ firm.primary_phone }}</span>
                {% else %}
                <span class="firm-contact-muted">Brak kontaktu</span>
                {% endif %}
              </div>
              <div class="firm-row-stats">
                <span>{{ firm.contact_count }} kontaktów</span>
                <span>{{ firm.property_count }} nieruchomości</span>
                <span>{{ firm.scope_count }} zakresów</span>
              </div>
            </div>
            <div class="firm-row-chevron">&gt;</div>
          </div>
        </div>
        {% endfor %}
        {% if not firms %}
        <div class="empty-state">Brak firm do wyświetlenia.</div>
        {% endif %}
      </div>
      <script>
        document.querySelectorAll(".firm-row").forEach((row) => {
          row.addEventListener("click", (event) => {
            if (event.target.closest("a")) {
              return;
            }
            window.location = row.dataset.href;
          });
          row.addEventListener("keydown", (event) => {
            if (event.key === "Enter" || event.key === " ") {
              event.preventDefault();
              window.location = row.dataset.href;
            }
          });
        });
      </script>
    </div>
  </body>
</html>
