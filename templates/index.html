<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Nadzorca przeglƒÖd√≥w</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>

  <body>
    <div class="container">
      <div class="topbar">
        <div class="brand">
          <div class="brand-title">Nadzorca przeglƒÖd√≥w <span class="brand-version">{{ app_version }}</span></div>
        </div>
        <div class="user-panel">
          <a class="user-name user-link" href="{{ url_for('profile') }}">
            Zalogowany jako: <strong>{{ current_user.username if current_user else "-" }}</strong>
          </a>
          <form method="POST" action="{{ url_for('logout') }}" class="logout-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit" class="btn btn-ghost">Wyloguj</button>
          </form>
        </div>
      </div>

      <div class="nav-split">
        <div class="nav-left">
          {% set index_url = url_for('index', segment=active_segment) if active_segment else url_for('index') %}
          <a class="nav-pill is-active" href="{{ index_url }}">PrzeglƒÖdy</a>
          {% if current_user and current_user.role == "admin" %}
          <details class="app-nav-dropdown">
            <summary class="nav-pill">Admin</summary>
            <div class="app-nav-menu">
              <a class="app-nav-menu-link" href="{{ url_for('admin_properties') }}">Panel nieruchomo≈õci</a>
              <a class="app-nav-menu-link" href="{{ url_for('admin_users') }}">U≈ºytkownicy</a>
              <a class="app-nav-menu-link" href="{{ url_for('admin_notifications') }}">Powiadomienia</a>
            </div>
          </details>
          {% endif %}
        </div>
        <div class="nav-right">
          <a class="nav-pill" href="{{ url_for('firm_index') }}">Firmy</a>
        </div>
      </div>

      {% if segments %}
      <div class="segment-switch">
        {% for segment in segments %}
        <a class="segment-pill {% if segment.active %}is-active{% endif %}" href="{{ segment.url }}">{{ segment.label }}</a>
        {% endfor %}
      </div>
      {% endif %}

      <form method="GET" class="filters-form" id="filtersForm">
        {% if active_segment %}
        <input type="hidden" name="segment" value="{{ active_segment }}">
        {% endif %}
        <div class="properties-section">
          <div class="properties-head">
            <div class="properties-title-wrap">
              <div class="eyebrow">TWOJE NIERUCHOMO≈öCI</div>
            </div>
          </div>
          <div class="property-grid">
            {% for card in property_cards %}
            <div class="property-card {% if card.active %}is-active{% endif %}">
              <a
                href="{{ card.link }}"
                class="property-card-link"
                aria-label="Filtruj: {{ card.name | format_property }}"
              ></a>
              <div class="property-card-content">
                <div class="property-card-header">
                  <div class="property-card-name">{{ card.name | format_property }}</div>
                </div>
                {% if card.segment %}
                <div class="property-card-segment">{{ card.segment }}</div>
                {% endif %}
                <div class="property-card-counts">
                <a class="pill pill-overdue property-status-link" href="{{ card.overdue_link }}" title="Poka≈º zaleg≈Çe">
                  {{ card.overdue }} zaleg≈Çe
                </a>
                <a class="pill pill-upcoming property-status-link" href="{{ card.upcoming_link }}" title="Poka≈º nadchodzƒÖce">
                  {{ card.upcoming }} nadchodzƒÖce
                </a>
                <div class="pill-with-icon">
                  <a class="pill pill-current property-status-link" href="{{ card.current_link }}" title="Poka≈º aktualne">
                    {{ card.current }} aktualne
                  </a>
                  <a
                    class="property-calendar-link"
                    href="{{ url_for('calendar_view', property=card.name) }}"
                      aria-label="Kalendarz: {{ card.name | format_property }}"
                      title="Kalendarz"
                    >
                      <svg viewBox="0 0 24 24" aria-hidden="true">
                        <path
                          d="M7 3a1 1 0 0 1 1 1v1h8V4a1 1 0 1 1 2 0v1h2a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h2V4a1 1 0 1 1 2 0v1zm13 7H4v10h16V10z"
                          fill="currentColor"
                        />
                      </svg>
                    </a>
                  </div>
                </div>
                {% if card.next_due_label %}
                <div class="property-card-next">Najbli≈ºszy termin: {{ card.next_due_label }}</div>
                {% endif %}
              </div>
            </div>
            {% endfor %}
            {% if not property_cards %}
            <div class="property-card empty-card">Brak nieruchomo≈õci do wy≈õwietlenia</div>
            {% endif %}
          </div>
        </div>

        <div class="header-row">
          <h2>Lista przeglƒÖd√≥w</h2>
          <div class="header-actions"></div>
        </div>

        <div class="filters">
          <div class="toolbar">
            <div class="search-bar">
              <label class="sr-only" for="filterSearch">Szukaj</label>
              <input
                type="text"
                id="filterSearch"
                name="q"
                value="{{ request.args.get('q', '') }}"
                placeholder="Szukaj"
              />
            </div>
            <div class="toolbar-actions">
              <a href="{{ url_for('add', return_to=return_to) }}" class="btn btn-primary">‚ûï Dodaj przeglƒÖd</a>
              <div class="filter-shell">
                <button
                  type="button"
                  class="icon-trigger filter-trigger"
                  id="filterTrigger"
                  aria-expanded="false"
                  aria-controls="filterPanel"
                  aria-label="Filtry"
                  title="Filtry"
                >
                  <svg class="toolbar-icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path
                      d="M3 5h18l-7 8v5l-4 1v-6L3 5z"
                      fill="currentColor"
                    />
                  </svg>
                  {% if active_filter_count %}
                  <span class="filter-badge">{{ active_filter_count }}</span>
                  {% endif %}
                </button>
                <div class="filter-panel" id="filterPanel" role="dialog" aria-label="Filtry">
                  {% set current_sort = request.args.get('sort', 'default') %}
                  <div class="filter-panel-header">
                    <div class="filter-panel-title">Filtry</div>
                  </div>

                  <div class="filter-group">
                    <div class="filter-group-title">Sortowanie</div>
                    <div class="filter-options">
                      <label class="filter-option">
                        <input
                          type="radio"
                          name="sort"
                          value="default"
                          {% if current_sort == "default" %}checked{% endif %}
                        />
                        <span>Domy≈õlne</span>
                      </label>
                      <label class="filter-option">
                        <input
                          type="radio"
                          name="sort"
                          value="nieruchomosc"
                          {% if current_sort == "nieruchomosc" %}checked{% endif %}
                        />
                        <span>Nieruchomo≈õƒá</span>
                      </label>
                      <label class="filter-option">
                        <input
                          type="radio"
                          name="sort"
                          value="nazwa"
                          {% if current_sort == "nazwa" %}checked{% endif %}
                        />
                        <span>Nazwa</span>
                      </label>
                      <label class="filter-option">
                        <input
                          type="radio"
                          name="sort"
                          value="kolejna_data"
                          {% if current_sort == "kolejna_data" %}checked{% endif %}
                        />
                        <span>Kolejna data</span>
                      </label>
                    </div>
                  </div>

                  <div class="filter-group">
                    <div class="filter-group-title">Nieruchomo≈õƒá</div>
                    <div class="filter-options">
                      {% for p in used_properties %}
                      <label class="filter-option">
                        <input
                          type="checkbox"
                          name="nieruchomosc"
                          value="{{ p }}"
                          {% if p in selected_properties %}checked{% endif %}
                        />
                        <span>{{ p | format_property }}</span>
                      </label>
                      {% endfor %}
                      {% if not used_properties %}
                      <div class="filter-empty">Brak danych</div>
                      {% endif %}
                    </div>
                  </div>

                  <div class="filter-group">
                    <div class="filter-group-title">Status</div>
                    <div class="filter-options">
                      {% for s in used_status %}
                      <label class="filter-option">
                        <input
                          type="checkbox"
                          name="status"
                          value="{{ s }}"
                          {% if s in selected_status %}checked{% endif %}
                        />
                        <span>{{ s }}</span>
                      </label>
                      {% endfor %}
                      {% if not used_status %}
                      <div class="filter-empty">Brak danych</div>
                      {% endif %}
                    </div>
                  </div>

                  <div class="filter-group">
                    <div class="filter-group-title">PrzeglƒÖd</div>
                    <div class="filter-options">
                      {% for n in used_names %}
                      <label class="filter-option">
                        <input
                          type="checkbox"
                          name="nazwa"
                          value="{{ n }}"
                          {% if n in selected_names %}checked{% endif %}
                        />
                        <span>{{ n }}</span>
                      </label>
                      {% endfor %}
                      {% if not used_names %}
                      <div class="filter-empty">Brak danych</div>
                      {% endif %}
                    </div>
                  </div>

                  <div class="filter-group">
                    <div class="filter-group-title">Uwagi</div>
                    <div class="filter-options">
                      <label class="filter-option">
                        <input
                          type="checkbox"
                          name="uwagi"
                          value="tak"
                          {% if "tak" in selected_uwagi %}checked{% endif %}
                        />
                        <span>Ma uwagi</span>
                      </label>
                      <label class="filter-option">
                        <input
                          type="checkbox"
                          name="uwagi"
                          value="nie"
                          {% if "nie" in selected_uwagi %}checked{% endif %}
                        />
                        <span>Bez uwag</span>
                      </label>
                    </div>
                  </div>

                  <div class="filter-panel-actions">
                    <a href="{{ clear_filters_url }}" class="btn btn-ghost">Wyczy≈õƒá wszystko</a>
                  </div>
                </div>
              </div>
              <div class="filter-shell">
                <button
                  type="button"
                  class="icon-trigger export-trigger"
                  id="exportTrigger"
                  aria-expanded="false"
                  aria-controls="exportPanel"
                  aria-label="Eksport"
                  title="Eksport"
                >
                  <svg class="toolbar-icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path
                      d="M12 3a1 1 0 0 1 1 1v8.59l2.3-2.3 1.4 1.42-4.7 4.7-4.7-4.7 1.4-1.42 2.3 2.3V4a1 1 0 0 1 1-1zm-7 14h14v2H5v-2z"
                      fill="currentColor"
                    />
                  </svg>
                </button>
                <div class="filter-panel export-panel" id="exportPanel" role="dialog" aria-label="Eksport">
                  <a class="menu-item" href="{{ url_for('export_xlsx', **(args_dict or {})) }}">
                    <span class="menu-item-title">Pobierz XLSX</span>
                  </a>
                  <a class="menu-item" href="{{ url_for('export_csv', **(args_dict or {})) }}">
                    <span class="menu-item-title">Pobierz CSV</span>
                    <span class="menu-item-meta">CSV (dla integracji/importu)</span>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>

      {% if inspections %}
      <div class="table-card">
      <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Lp.</th>
            <th>Nieruchomo≈õƒá</th>
            <th>Nazwa</th>
            <th>Segment</th>
            <th>Firma</th>
            <th>Kontakt</th>
            <th>Ostatnia data</th>
            <th>Czƒôstotliwo≈õƒá</th>
            <th>Kolejna data</th>
            <th>Status</th>
            <th>Opis</th>
            <th>Akcje</th>
          </tr>
        </thead>

        <tbody>
          {% for ins in inspections %}
          {% set status = ins.status %}
          {% if status == "Zaleg≈Çy" %}
            {% set status_class = "status-zalegly" %}
            {% set badge_class = "badge badge-zalegly" %}
          {% elif status == "NadchodzƒÖce" %}
            {% set status_class = "status-nadchodzace" %}
            {% set badge_class = "badge badge-nadchodzace" %}
          {% else %}
            {% set status_class = "status-aktualne" %}
            {% set badge_class = "badge badge-aktualne" %}
          {% endif %}

          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ ins.nieruchomosc | format_property }}</td>
            <td>{{ ins.nazwa }}</td>


            <td>{{ ins.segment or "-" }}</td>

            <td>{{ ins.firma or "Brak danych" }}</td>

            <td class="contact-cell">
              {% if ins.telefon or ins.email %}
                <div class="contact-wrapper">
                  {% if ins.telefon %}
                  <div class="contact-phone">
                    üìû <span>{{ ins.telefon }}</span>
                  </div>
                  {% endif %}
                  {% if ins.email %}
                  <div class="contact-email">
                    ‚úâÔ∏è <span>{{ ins.email }}</span>
                  </div>
                  {% endif %}
                </div>
              {% else %}
              <span class="contact-none">Brak danych</span>
              {% endif %}
            </td>

            <td>
              {% if ins.ostatnia_data %}
                {{ ins.ostatnia_data[8:10] }}.{{ ins.ostatnia_data[5:7] }}.{{ ins.ostatnia_data[0:4] }}
              {% else %}-{% endif %}
            </td>

            <td>{{ ins.czestotliwosc_miesiace }}</td>

            <td>
              {% if ins.kolejna_data %}
                {{ ins.kolejna_data[8:10] }}.{{ ins.kolejna_data[5:7] }}.{{ ins.kolejna_data[0:4] }}
              {% else %}-{% endif %}
            </td>

            <td class="{{ status_class }}">
              <span class="{{ badge_class }}">{{ ins.status }}</span>
            </td>

            <td>
              {% set opis = ins.opis or "" %}
              {% if opis and opis|trim|lower != "brak uwag" %}
                <button
                  type="button"
                  class="uwagi-btn"
                  data-opis="{{ opis|e }}"
                >
                  SƒÖ uwagi
                </button>
              {% else %}
                Brak uwag
              {% endif %}
            </td>

            <td class="actions-cell">
              <div class="action-toolbar">
                <a
                  href="{{ url_for('edit', idx=ins.idx, return_to=return_to) }}"
                  class="action-icon"
                  title="Edytuj"
                  aria-label="Edytuj"
                >
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path
                      d="M4 17.5V20h2.5l9.2-9.2-2.5-2.5L4 17.5zm12-10.7 2.5 2.5 1.4-1.4a1 1 0 0 0 0-1.4l-1.1-1.1a1 1 0 0 0-1.4 0l-1.4 1.4z"
                      fill="currentColor"
                    />
                  </svg>
                </a>
                <form
                  method="POST"
                  action="{{ url_for('delete', idx=ins.idx) }}"
                  class="action-form"
                  onsubmit="return confirm('Na pewno usunƒÖƒá ten przeglƒÖd?');"
                >
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                  <input type="hidden" name="return_to" value="{{ return_to }}">
                  <button type="submit" class="action-icon action-icon--danger" title="Usu≈Ñ" aria-label="Usu≈Ñ">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <path
                        d="M7 7h10l-1 12H8L7 7zm2-3h6l1 2H8l1-2z"
                        fill="currentColor"
                      />
                    </svg>
                  </button>
                </form>
                <a
                  href="{{ url_for('history', inspection_id=ins.id, return_to=return_to) }}"
                  class="action-icon"
                  title="Historia"
                  aria-label="Historia"
                >
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path
                      d="M12 3a9 9 0 1 0 9 9h-2a7 7 0 1 1-7-7V3zm-1 5h2v5l4 2-1 1.7-5-2.7V8z"
                      fill="currentColor"
                    />
                  </svg>
                </a>
              </div>
            </td>
          </tr>

          {% endfor %}
        </tbody>
      </table>
      </div>
      </div>

      <div class="pagination">
        <div>Pozycje: {{ total_items }} | Strona {{ page }} z {{ total_pages }}</div>
        <div class="pager-buttons">
          {% if prev_url %}
          <a href="{{ prev_url }}" class="btn">¬´ Poprzednia</a>
          {% endif %}
          {% if next_url %}
          <a href="{{ next_url }}" class="btn">Nastƒôpna ¬ª</a>
          {% endif %}
        </div>
      </div>

      {% else %}
      <p class="empty">
        Brak przeglƒÖd√≥w
      </p>
      {% endif %}
    </div>

    <div id="uwagiModal" class="modal">
      <div class="modal-content">
        <button type="button" class="modal-close">&times;</button>
        <h3>Uwagi do przeglƒÖdu</h3>
        <p id="uwagiText"></p>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const filtersForm = document.getElementById('filtersForm');
        const popovers = [];
        const popoverShells = [];

        if (filtersForm) {
          const submitFilters = () => {
            if (typeof filtersForm.requestSubmit === 'function') {
              filtersForm.requestSubmit();
            } else {
              filtersForm.submit();
            }
          };

          filtersForm
            .querySelectorAll('.filter-panel input[type="checkbox"], .filter-panel input[type="radio"]')
            .forEach(input => {
            input.addEventListener('change', submitFilters);
          });
        }

        const closeAllPopovers = () => {
          popovers.forEach(item => item.close());
        };

        const setupPopover = (triggerId, panelId) => {
          const trigger = document.getElementById(triggerId);
          const panel = document.getElementById(panelId);
          if (!trigger || !panel) return;

          const shell = trigger.closest('.filter-shell');
          if (shell) {
            popoverShells.push(shell);
          }

          const open = () => {
            panel.classList.add('is-open');
            trigger.setAttribute('aria-expanded', 'true');
          };

          const close = () => {
            panel.classList.remove('is-open');
            trigger.setAttribute('aria-expanded', 'false');
          };

          popovers.push({ panel, close });

          trigger.addEventListener('click', event => {
            event.stopPropagation();
            const isOpen = panel.classList.contains('is-open');
            closeAllPopovers();
            if (!isOpen) {
              open();
            }
          });
        };

        setupPopover('filterTrigger', 'filterPanel');
        setupPopover('exportTrigger', 'exportPanel');

        document.addEventListener('click', event => {
          if (popoverShells.some(shell => shell && shell.contains(event.target))) {
            return;
          }
          closeAllPopovers();
        });

        document.addEventListener('keydown', event => {
          if (event.key === 'Escape') {
            closeAllPopovers();
          }
        });

        const modal = document.getElementById('uwagiModal');
        const modalText = document.getElementById('uwagiText');
        const closeBtn = modal.querySelector('.modal-close');

        document.addEventListener('click', e => {
          const btn = e.target.closest('.uwagi-btn');
          if (!btn) return;

          modalText.textContent = btn.dataset.opis || '';
          modal.classList.add('show');
        });

        closeBtn.addEventListener('click', () => modal.classList.remove('show'));
        modal.addEventListener('click', e => {
          if (e.target === modal) modal.classList.remove('show');
        });
      });

    </script>
  </body>
</html>
