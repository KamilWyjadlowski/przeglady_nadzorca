<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Nadzorca przeglƒÖd√≥w</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>

  <body>
    <div class="container">
      <div class="topbar">
        <div class="brand">
          <strong>Nadzorca przeglƒÖd√≥w</strong>
          <span class="tag">Alpha 1.0</span>
        </div>
        <div class="user-panel">
          <div class="user-name">
            Zalogowany jako <strong>{{ current_user.username if current_user else "-" }}</strong>
          </div>
          <a href="{{ url_for('profile') }}" class="btn">Profil</a>
          <a href="{{ url_for('calendar_view') }}" class="btn">Kalendarz</a>
          {% if current_user and current_user.role == "admin" %}
          <a href="{{ url_for('admin_properties') }}" class="btn">Panel nieruchomo≈õci</a>
          <a href="{{ url_for('admin_users') }}" class="btn">U≈ºytkownicy</a>
          <a href="{{ url_for('admin_notifications') }}" class="btn">Powiadomienia</a>
          {% endif %}
          <form method="POST" action="{{ url_for('logout') }}" class="logout-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit" class="btn btn-ghost">Wyloguj</button>
          </form>
        </div>
      </div>

      <form method="GET" class="filters-form" id="filtersForm">
        <div class="header-row">
          <h2>Lista przeglƒÖd√≥w</h2>
          <div class="header-actions">
            <a href="{{ url_for('add') }}" class="btn btn-primary">‚ûï Dodaj przeglƒÖd</a>
            <a
              href="{{ url_for('export_csv', **(args_dict or {})) }}"
              class="btn btn-ghost"
              >‚¨áÔ∏è Eksport CSV</a
            >
          </div>
        </div>

        <div class="properties-section">
          <div class="properties-head">
            <div>
              <div class="eyebrow">Twoje nieruchomo≈õci</div>
              <div class="properties-title">Kliknij kafelek, aby otworzyƒá przeglƒÖdy dla wybranego obiektu.</div>
            </div>
            <div class="properties-actions">
              {% if request.args.get('nieruchomosc') %}
              <a href="{{ clear_property_url }}" class="btn btn-ghost">Poka≈º wszystkie</a>
              {% endif %}
            </div>
          </div>
          <div class="property-grid">
            {% for card in property_cards %}
            <a href="{{ card.link }}" class="property-card {% if card.active %}is-active{% endif %}">
              <div class="property-card-header">
                <div class="property-card-name">{{ card.name }}</div>
                {% if card.property_id %}
                <span class="property-chip">ID {{ card.property_id }}</span>
                {% endif %}
              </div>
              {% if card.segment %}
              <div class="property-card-segment">{{ card.segment }}</div>
              {% endif %}
              <div class="property-card-counts">
                <span class="pill pill-overdue">{{ card.overdue }} zaleg≈Çe</span>
                <span class="pill pill-upcoming">{{ card.upcoming }} nadchodzƒÖce</span>
                <span class="pill pill-current">{{ card.current }} aktualne</span>
              </div>
              {% if card.next_due_label %}
              <div class="property-card-next">Najbli≈ºszy termin: {{ card.next_due_label }}</div>
              {% endif %}
            </a>
            {% endfor %}
            {% if not property_cards %}
            <div class="property-card empty-card">Brak nieruchomo≈õci do wy≈õwietlenia</div>
            {% endif %}
          </div>
        </div>

        <div class="filters">
          <div class="filter-field filter-field-search">
            <label class="sr-only" for="filterSearch">Szukaj</label>
            <input
              type="text"
              id="filterSearch"
              name="q"
              value="{{ request.args.get('q', '') }}"
              placeholder="Szukaj"
            />
          </div>
          <div class="filter-actions">
            <div class="filter-shell">
              <button
                type="button"
                class="btn btn-ghost filter-trigger"
                id="filterTrigger"
                aria-expanded="false"
                aria-controls="filterPanel"
                aria-label="Filtry"
                title="Filtry"
              >
                <svg class="filter-icon" viewBox="0 0 24 24" aria-hidden="true">
                  <path
                    d="M3 5h18l-7 8v5l-4 1v-6L3 5z"
                    fill="currentColor"
                  />
                </svg>
                {% if active_filter_count %}
                <span class="filter-badge">{{ active_filter_count }}</span>
                {% endif %}
              </button>
              <div class="filter-panel" id="filterPanel" role="dialog" aria-label="Filtry">
                {% set current_sort = request.args.get('sort', 'default') %}
                <div class="filter-panel-header">
                  <div class="filter-panel-title">Filtry</div>
                </div>

                <div class="filter-group">
                  <div class="filter-group-title">Sortowanie</div>
                  <div class="filter-options">
                    <label class="filter-option">
                      <input
                        type="radio"
                        name="sort"
                        value="default"
                        {% if current_sort == "default" %}checked{% endif %}
                      />
                      <span>Domy≈õlne</span>
                    </label>
                    <label class="filter-option">
                      <input
                        type="radio"
                        name="sort"
                        value="nieruchomosc"
                        {% if current_sort == "nieruchomosc" %}checked{% endif %}
                      />
                      <span>Nieruchomo≈õƒá</span>
                    </label>
                    <label class="filter-option">
                      <input
                        type="radio"
                        name="sort"
                        value="nazwa"
                        {% if current_sort == "nazwa" %}checked{% endif %}
                      />
                      <span>Nazwa</span>
                    </label>
                    <label class="filter-option">
                      <input
                        type="radio"
                        name="sort"
                        value="kolejna_data"
                        {% if current_sort == "kolejna_data" %}checked{% endif %}
                      />
                      <span>Kolejna data</span>
                    </label>
                  </div>
                </div>

                <div class="filter-group">
                  <div class="filter-group-title">Nieruchomo≈õƒá</div>
                  <div class="filter-options">
                    {% for p in used_properties %}
                    <label class="filter-option">
                      <input
                        type="checkbox"
                        name="nieruchomosc"
                        value="{{ p }}"
                        {% if p in selected_properties %}checked{% endif %}
                      />
                      <span>{{ p }}</span>
                    </label>
                    {% endfor %}
                    {% if not used_properties %}
                    <div class="filter-empty">Brak danych</div>
                    {% endif %}
                  </div>
                </div>

                <div class="filter-group">
                  <div class="filter-group-title">PrzeglƒÖd</div>
                  <div class="filter-options">
                    {% for n in used_names %}
                    <label class="filter-option">
                      <input
                        type="checkbox"
                        name="nazwa"
                        value="{{ n }}"
                        {% if n in selected_names %}checked{% endif %}
                      />
                      <span>{{ n }}</span>
                    </label>
                    {% endfor %}
                    {% if not used_names %}
                    <div class="filter-empty">Brak danych</div>
                    {% endif %}
                  </div>
                </div>

                <div class="filter-group">
                  <div class="filter-group-title">Status</div>
                  <div class="filter-options">
                    {% for s in used_status %}
                    <label class="filter-option">
                      <input
                        type="checkbox"
                        name="status"
                        value="{{ s }}"
                        {% if s in selected_status %}checked{% endif %}
                      />
                      <span>{{ s }}</span>
                    </label>
                    {% endfor %}
                    {% if not used_status %}
                    <div class="filter-empty">Brak danych</div>
                    {% endif %}
                  </div>
                </div>

                <div class="filter-group">
                  <div class="filter-group-title">Uwagi</div>
                  <div class="filter-options">
                    <label class="filter-option">
                      <input
                        type="checkbox"
                        name="uwagi"
                        value="tak"
                        {% if "tak" in selected_uwagi %}checked{% endif %}
                      />
                      <span>Ma uwagi</span>
                    </label>
                    <label class="filter-option">
                      <input
                        type="checkbox"
                        name="uwagi"
                        value="nie"
                        {% if "nie" in selected_uwagi %}checked{% endif %}
                      />
                      <span>Bez uwag</span>
                    </label>
                  </div>
                </div>

                <div class="filter-group">
                  <div class="filter-group-title">Segment</div>
                  <div class="filter-options">
                    {% for seg in used_segments %}
                    <label class="filter-option">
                      <input
                        type="checkbox"
                        name="segment"
                        value="{{ seg }}"
                        {% if seg in selected_segments %}checked{% endif %}
                      />
                      <span>{{ seg }}</span>
                    </label>
                    {% endfor %}
                    {% if not used_segments %}
                    <div class="filter-empty">Brak danych</div>
                    {% endif %}
                  </div>
                </div>

                <div class="filter-panel-actions">
                  <a href="{{ clear_filters_url }}" class="btn btn-ghost">Wyczy≈õƒá wszystko</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>

      {% if inspections %}
      <div class="table-card">
      <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Lp.</th>
            <th>Nieruchomo≈õƒá</th>
            <th>Nazwa</th>
            <th>Segment</th>
            <th>Firma</th>
            <th>Kontakt</th>
            <th>Ostatnia data</th>
            <th>Czƒôstotliwo≈õƒá</th>
            <th>Kolejna data</th>
            <th>Status</th>
            <th>Opis</th>
            <th>Akcje</th>
          </tr>
        </thead>

        <tbody>
          {% for ins in inspections %}
          {% set status = ins.status %}
          {% if status == "Zaleg≈Çy" %}
            {% set status_class = "status-zalegly" %}
            {% set badge_class = "badge badge-zalegly" %}
          {% elif status == "NadchodzƒÖce" %}
            {% set status_class = "status-nadchodzace" %}
            {% set badge_class = "badge badge-nadchodzace" %}
          {% else %}
            {% set status_class = "status-aktualne" %}
            {% set badge_class = "badge badge-aktualne" %}
          {% endif %}

          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ ins.nieruchomosc }}</td>
            <td>{{ ins.nazwa }}</td>


            <td>{{ ins.segment or "-" }}</td>

            <td>{{ ins.firma or "Brak danych" }}</td>

            <td class="contact-cell">
              {% if ins.telefon or ins.email %}
                <div class="contact-wrapper">
                  {% if ins.telefon %}
                  <div class="contact-phone">
                    üìû <span>{{ ins.telefon }}</span>
                  </div>
                  {% endif %}
                  {% if ins.email %}
                  <div class="contact-email">
                    ‚úâÔ∏è <span>{{ ins.email }}</span>
                  </div>
                  {% endif %}
                </div>
              {% else %}
              <span class="contact-none">Brak danych</span>
              {% endif %}
            </td>

            <td>
              {% if ins.ostatnia_data %}
                {{ ins.ostatnia_data[8:10] }}.{{ ins.ostatnia_data[5:7] }}.{{ ins.ostatnia_data[0:4] }}
              {% else %}-{% endif %}
            </td>

            <td>{{ ins.czestotliwosc_miesiace }}</td>

            <td>
              {% if ins.kolejna_data %}
                {{ ins.kolejna_data[8:10] }}.{{ ins.kolejna_data[5:7] }}.{{ ins.kolejna_data[0:4] }}
              {% else %}-{% endif %}
            </td>

            <td class="{{ status_class }}">
              <span class="{{ badge_class }}">{{ ins.status }}</span>
            </td>

            <td>
              {% set opis = ins.opis or "" %}
              {% if opis and opis|trim|lower != "brak uwag" %}
                <button
                  type="button"
                  class="uwagi-btn"
                  data-opis="{{ opis|e }}"
                >
                  SƒÖ uwagi
                </button>
              {% else %}
                Brak uwag
              {% endif %}
            </td>

            <td class="actions-cell">
              <a
                href="{{ url_for('edit', idx=ins.idx) }}"
                class="action-btn"
                title="Edytuj"
              >
                ‚úèÔ∏è
              </a>

              <form
                method="POST"
                action="{{ url_for('delete', idx=ins.idx) }}"
                style="display: inline"
                onsubmit="return confirm('Na pewno usunƒÖƒá ten przeglƒÖd?');"
              >
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button type="submit" class="action-btn action-delete" title="Usu≈Ñ">üóë</button>
              </form>
              <a
                href="{{ url_for('history', inspection_id=ins.id) }}"
                class="action-btn"
                title="Historia"
              >üìú</a>
            </td>
          </tr>

          {% endfor %}
        </tbody>
      </table>
      </div>
      </div>

      <div class="pagination">
        <div>Pozycje: {{ total_items }} | Strona {{ page }} z {{ total_pages }}</div>
        <div class="pager-buttons">
          {% if prev_url %}
          <a href="{{ prev_url }}" class="btn">¬´ Poprzednia</a>
          {% endif %}
          {% if next_url %}
          <a href="{{ next_url }}" class="btn">Nastƒôpna ¬ª</a>
          {% endif %}
        </div>
      </div>

      {% else %}
      <p class="empty">
        Brak przeglƒÖd√≥w
      </p>
      {% endif %}
    </div>

    <div id="uwagiModal" class="modal">
      <div class="modal-content">
        <button type="button" class="modal-close">&times;</button>
        <h3>Uwagi do przeglƒÖdu</h3>
        <p id="uwagiText"></p>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const filtersForm = document.getElementById('filtersForm');
        const filterTrigger = document.getElementById('filterTrigger');
        const filterPanel = document.getElementById('filterPanel');
        const filterShell = filterTrigger ? filterTrigger.closest('.filter-shell') : null;

        if (filtersForm) {
          const submitFilters = () => {
            if (typeof filtersForm.requestSubmit === 'function') {
              filtersForm.requestSubmit();
            } else {
              filtersForm.submit();
            }
          };

          filtersForm
            .querySelectorAll('.filter-panel input[type="checkbox"], .filter-panel input[type="radio"]')
            .forEach(input => {
            input.addEventListener('change', submitFilters);
          });
        }

        if (filterTrigger && filterPanel) {
          const closePanel = () => {
            filterPanel.classList.remove('is-open');
            filterTrigger.setAttribute('aria-expanded', 'false');
          };
          const togglePanel = () => {
            const isOpen = filterPanel.classList.contains('is-open');
            filterPanel.classList.toggle('is-open', !isOpen);
            filterTrigger.setAttribute('aria-expanded', String(!isOpen));
          };

          filterTrigger.addEventListener('click', event => {
            event.stopPropagation();
            togglePanel();
          });

          document.addEventListener('click', event => {
            if (!filterPanel.classList.contains('is-open')) return;
            if (filterShell && filterShell.contains(event.target)) return;
            closePanel();
          });

          document.addEventListener('keydown', event => {
            if (event.key === 'Escape') {
              closePanel();
            }
          });
        }

        const modal = document.getElementById('uwagiModal');
        const modalText = document.getElementById('uwagiText');
        const closeBtn = modal.querySelector('.modal-close');

        document.addEventListener('click', e => {
          const btn = e.target.closest('.uwagi-btn');
          if (!btn) return;

          modalText.textContent = btn.dataset.opis || '';
          modal.classList.add('show');
        });

        closeBtn.addEventListener('click', () => modal.classList.remove('show'));
        modal.addEventListener('click', e => {
          if (e.target === modal) modal.classList.remove('show');
        });
      });

      {% if current_user %}
      {% endif %}
    </script>
  </body>
</html>
