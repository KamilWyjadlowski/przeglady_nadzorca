<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Nadzorca przeglÄ…dÃ³w</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>

  <body>
    <div class="container">
      <div class="topbar">
        <div class="brand">
          <strong>Nadzorca przeglÄ…dÃ³w</strong>
          <span class="tag">Alpha 1.0</span>
        </div>
        <div class="user-panel">
          <div class="user-name">
            Zalogowany jako <strong>{{ current_user.username if current_user else "-" }}</strong>
          </div>
          <a href="{{ url_for('calendar_view') }}" class="btn">Kalendarz</a>
          {% if current_user and current_user.role == "admin" %}
          <a href="{{ url_for('admin_properties') }}" class="btn">Panel nieruchomoÅ›ci</a>
          <a href="{{ url_for('admin_users') }}" class="btn">UÅ¼ytkownicy</a>
          {% endif %}
          <form method="POST" action="{{ url_for('logout') }}" class="logout-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit" class="btn btn-ghost">Wyloguj</button>
          </form>
        </div>
      </div>

      <div class="header-row">
        <h2>Lista przeglÄ…dÃ³w</h2>
        <a href="{{ url_for('add') }}" class="btn btn-primary">â• Dodaj przeglÄ…d</a>
      </div>

      <form method="GET" class="filters">
        <div>
          <label>Szukaj</label>
          <input
            type="text"
            name="q"
            value="{{ request.args.get('q', '') }}"
            placeholder="nazwa, nieruchomoÅ›Ä‡"
          />
        </div>

        <div>
          <label>NieruchomoÅ›Ä‡</label>
          <select name="nieruchomosc">
            <option value="">(wszystkie)</option>
            {% for p in used_properties %}
            <option
              value="{{ p }}"
              {% if request.args.get('nieruchomosc') == p %}selected{% endif %}
            >
              {{ p }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label>PrzeglÄ…d</label>
          <select name="nazwa">
            <option value="">(wszystkie)</option>
            {% for n in used_names %}
            <option
              value="{{ n }}"
              {% if request.args.get('nazwa') == n %}selected{% endif %}
            >
              {{ n }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label>Status</label>
          <select name="status">
            <option value="">(wszystkie)</option>
            {% for s in used_status %}
            <option
              value="{{ s }}"
              {% if request.args.get('status') == s %}selected{% endif %}
            >
              {{ s }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label>Uwagi</label>
          <select name="uwagi">
            <option value="">(wszystkie)</option>
            <option value="tak" {% if request.args.get('uwagi') == "tak" %}selected{% endif %}>
              Ma uwagi
            </option>
            <option value="nie" {% if request.args.get('uwagi') == "nie" %}selected{% endif %}>
              Bez uwag
            </option>
          </select>
        </div>

        <div>
          <label>Segment</label>
          <select name="segment">
            <option value="">(wszystkie)</option>
            {% for seg in used_segments %}
            <option
              value="{{ seg }}"
              {% if request.args.get('segment') == seg %}selected{% endif %}
            >
              {{ seg }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label>Sortowanie</label>
          <select name="sort">
            <option value="default" {% if request.args.get('sort','default') == 'default' %}selected{% endif %}>DomyÅ›lne</option>
            <option value="nieruchomosc" {% if request.args.get('sort') == 'nieruchomosc' %}selected{% endif %}>NieruchomoÅ›Ä‡</option>
            <option value="nazwa" {% if request.args.get('sort') == 'nazwa' %}selected{% endif %}>Nazwa</option>
            <option value="kolejna_data" {% if request.args.get('sort') == 'kolejna_data' %}selected{% endif %}>Kolejna data</option>
          </select>
        </div>

        <div>
          <button type="submit" class="btn">Filtruj</button>
        </div>
      </form>

      {% if inspections %}
      <table>
        <thead>
          <tr>
            <th>Lp.</th>
            <th>NieruchomoÅ›Ä‡</th>
            <th>Nazwa</th>
            <th>Segment</th>
            <th>Firma</th>
            <th>Kontakt</th>
            <th>Ostatnia data</th>
            <th>CzÄ™stotliwoÅ›Ä‡</th>
            <th>Kolejna data</th>
            <th>Status</th>
            <th>Opis</th>
            <th>Akcje</th>
          </tr>
        </thead>

        <tbody>
          {% for ins in inspections %}
          {% set status = ins.status %}
          {% if status == "ZalegÅ‚y" %}
            {% set status_class = "status-zalegly" %}
            {% set badge_class = "badge badge-zalegly" %}
          {% elif status == "NadchodzÄ…ce" %}
            {% set status_class = "status-nadchodzace" %}
            {% set badge_class = "badge badge-nadchodzace" %}
          {% else %}
            {% set status_class = "status-aktualne" %}
            {% set badge_class = "badge badge-aktualne" %}
          {% endif %}

          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ ins.nieruchomosc }}</td>
            <td>{{ ins.nazwa }}</td>


            <td>{{ ins.segment or "-" }}</td>

            <td>{{ ins.firma or "Brak danych" }}</td>

            <td class="contact-cell">
              {% if ins.telefon or ins.email %}
                <div class="contact-wrapper">
                  {% if ins.telefon %}
                  <div class="contact-phone">
                    ğŸ“ <span>{{ ins.telefon }}</span>
                  </div>
                  {% endif %}
                  {% if ins.email %}
                  <div class="contact-email">
                    âœ‰ï¸ <span>{{ ins.email }}</span>
                  </div>
                  {% endif %}
                </div>
              {% else %}
              <span class="contact-none">Brak danych</span>
              {% endif %}
            </td>

            <td>
              {% if ins.ostatnia_data %}
                {{ ins.ostatnia_data[8:10] }}.{{ ins.ostatnia_data[5:7] }}.{{ ins.ostatnia_data[0:4] }}
              {% else %}-{% endif %}
            </td>

            <td>{{ ins.czestotliwosc_miesiace }}</td>

            <td>
              {% if ins.kolejna_data %}
                {{ ins.kolejna_data[8:10] }}.{{ ins.kolejna_data[5:7] }}.{{ ins.kolejna_data[0:4] }}
              {% else %}-{% endif %}
            </td>

            <td class="{{ status_class }}">
              <span class="{{ badge_class }}">{{ ins.status }}</span>
            </td>

            <td>
              {% set opis = ins.opis or "" %}
              {% if opis and opis|trim|lower != "brak uwag" %}
                <button
                  type="button"
                  class="uwagi-btn"
                  data-opis="{{ opis|e }}"
                >
                  SÄ… uwagi
                </button>
              {% else %}
                Brak uwag
              {% endif %}
            </td>

            <td class="actions-cell">
              <a
                href="{{ url_for('edit', idx=ins.idx) }}"
                class="action-btn"
                title="Edytuj"
              >
                âœï¸
              </a>

              <form
                method="POST"
                action="{{ url_for('delete', idx=ins.idx) }}"
                style="display: inline"
                onsubmit="return confirm('Na pewno usunÄ…Ä‡ ten przeglÄ…d?');"
              >
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button type="submit" class="action-btn action-delete" title="UsuÅ„">ğŸ—‘</button>
              </form>
              <a
                href="{{ url_for('history', inspection_id=ins.id) }}"
                class="action-btn"
                title="Historia"
              >ğŸ“œ</a>
            </td>
          </tr>

          {% endfor %}
        </tbody>
      </table>

      <div class="pagination">
        <div>Pozycje: {{ total_items }} | Strona {{ page }} z {{ total_pages }}</div>
        <div class="pager-buttons">
          {% if prev_url %}
          <a href="{{ prev_url }}" class="btn">Â« Poprzednia</a>
          {% endif %}
          {% if next_url %}
          <a href="{{ next_url }}" class="btn">NastÄ™pna Â»</a>
          {% endif %}
        </div>
      </div>

      {% else %}
      <p class="empty">
        Brak przeglÄ…dÃ³w
      </p>
      {% endif %}
    </div>

    <div id="uwagiModal" class="modal">
      <div class="modal-content">
        <button type="button" class="modal-close">&times;</button>
        <h3>Uwagi do przeglÄ…du</h3>
        <p id="uwagiText"></p>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {

        document.querySelectorAll('.filters select').forEach(select => {
          select.addEventListener('change', () => {
            select.form.submit();
          });
        });

        const modal = document.getElementById('uwagiModal');
        const modalText = document.getElementById('uwagiText');
        const closeBtn = modal.querySelector('.modal-close');

        document.addEventListener('click', e => {
          const btn = e.target.closest('.uwagi-btn');
          if (!btn) return;

          modalText.textContent = btn.dataset.opis || '';
          modal.classList.add('show');
        });

        closeBtn.addEventListener('click', () => modal.classList.remove('show'));
        modal.addEventListener('click', e => {
          if (e.target === modal) modal.classList.remove('show');
        });
      });

      {% if current_user %}
      {% endif %}
    </script>
  </body>
</html>
