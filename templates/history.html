<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Historia przeglądu</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <div class="container">
      <div class="topbar">
        <div class="brand">
          <strong>Historia przeglądu</strong>
          <span class="tag">{{ inspection.nazwa }} — {{ inspection.nieruchomosc }}</span>
        </div>
        <div class="user-panel">
          <a href="{{ url_for('index') }}" class="btn">← Lista</a>
          {% if current_user and current_user.role == "admin" %}
          <a href="{{ url_for('admin_properties') }}" class="btn">Panel nieruchomości</a>
          {% endif %}
          <form method="POST" action="{{ url_for('logout') }}" class="logout-form">
            <button type="submit" class="btn btn-ghost">Wyloguj</button>
          </form>
        </div>
      </div>

      <h2>Historia wystąpień</h2>
      <p>
        Szablon: <strong>{{ inspection.nazwa }}</strong>,
        nieruchomość: <strong>{{ inspection.nieruchomosc }}</strong>
        (co {{ inspection.czestotliwosc_miesiace }} mies.)
      </p>

      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Termin</th>
            <th>Wykonano</th>
            <th>Status</th>
            <th>Kto</th>
            <th>Notatka</th>
            <th>Akcje</th>
          </tr>
        </thead>
        <tbody>
          {% for occ in occurrences %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ occ.due_date.strftime("%d.%m.%Y") if occ.due_date else "-" }}</td>
            <td>{{ occ.done_date.strftime("%d.%m.%Y") if occ.done_date else "—" }}</td>
            <td>
              {% if occ.status == "done" %}
                Wykonany
              {% elif occ.status == "planned" %}
                Zaplanowany
              {% elif occ.status == "overdue" %}
                Zaległy
              {% else %}
                {{ occ.status }}
              {% endif %}
            </td>
            <td>{{ occ.performed_by or "—" }}</td>
            <td>{{ occ.note or "—" }}</td>
            <td>
              {% if occ.status != "done" %}
              <form method="POST" action="{{ url_for('complete_occurrence', occ_id=occ.id) }}" style="display:inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="date" name="done_date" value="{{ today.isoformat() }}">
                <button type="submit" class="btn btn-small">Oznacz jako wykonane</button>
              </form>
              {% endif %}

              <form method="POST" action="{{ url_for('update_occurrence', occ_id=occ.id) }}" class="inline-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="inline-fields">
                  <input type="date" name="due_date" value="{{ occ.due_date.isoformat() if occ.due_date else '' }}" title="Termin">
                  <input type="date" name="done_date" value="{{ occ.done_date.isoformat() if occ.done_date else '' }}" title="Wykonano">
                  <select name="status" title="Status">
                    <option value="planned" {% if occ.status == "planned" %}selected{% endif %}>Zaplanowany</option>
                    <option value="done" {% if occ.status == "done" %}selected{% endif %}>Wykonany</option>
                    <option value="overdue" {% if occ.status == "overdue" %}selected{% endif %}>Zaległy</option>
                  </select>
                  <input type="text" name="performed_by" value="{{ occ.performed_by or '' }}" placeholder="Kto" title="Kto">
                  <input type="text" name="note" value="{{ occ.note or '' }}" placeholder="Notatka" title="Notatka">
                  <button type="submit" class="btn btn-small">Zapisz</button>
                </div>
              </form>

              <form method="POST" action="{{ url_for('delete_occurrence', occ_id=occ.id) }}" style="display:inline" onsubmit="return confirm('Usunąć to wystąpienie?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button type="submit" class="btn btn-small action-delete">Usuń</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </body>
</html>
