<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>
      {% if mode == "add" %}Dodaj przeglƒÖd{% else %}Edytuj przeglƒÖd{% endif %}
    </title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  </head>

  <body>
    <div class="container">
      <div class="topbar">
        <div class="brand">
          <div class="brand-title">Nadzorca przeglƒÖd√≥w <span class="brand-version">{{ app_version }}</span></div>
        </div>
        <div class="user-panel">
          <a class="user-name user-link" href="{{ url_for('profile') }}">
            Zalogowany jako <strong>{{ current_user.username if current_user else "-" }}</strong>
          </a>
                    {% if current_user and current_user.role == "admin" %}
          <a href="{{ url_for('admin_properties') }}" class="btn">Panel nieruchomo≈õci</a>
          <a href="{{ url_for('admin_users') }}" class="btn">U≈ºytkownicy</a>
          <a href="{{ url_for('admin_notifications') }}" class="btn">Powiadomienia</a>
          {% endif %}
          <form method="POST" action="{{ url_for('logout') }}" class="logout-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit" class="btn btn-ghost">Wyloguj</button>
          </form>
        </div>
      </div>

      <h2>
        {% if mode == "add" %}Dodaj przeglƒÖd{% else %}Edytuj przeglƒÖd{% endif %}
      </h2>

      <form method="post" class="form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        {% if return_to %}
        <input type="hidden" name="return_to" value="{{ return_to }}">
        {% endif %}
        <div class="field">
          <label for="nazwa">Nazwa przeglƒÖdu</label>
          <input
            type="text"
            id="nazwa"
            name="nazwa"
            value="{{ form.nazwa }}"
            list="nazwa_suggestions"
            autocomplete="off"
          />
          <datalist id="nazwa_suggestions">
            {% for n in used_names %}
            <option value="{{ n }}"></option>
            {% endfor %}
          </datalist>

          {% if errors.nazwa %}
          <div class="error">{{ errors.nazwa }}</div>
          {% endif %}
        </div>

        <div class="field">
          <label for="nieruchomosc">Nieruchomo≈õƒá</label>
          <input
            type="text"
            id="nieruchomosc"
            name="nieruchomosc"
            value="{{ form.nieruchomosc }}"
            list="nieruchomosci_suggestions"
            autocomplete="off"
          />
          <datalist id="nieruchomosci_suggestions">
            {% for n in used_properties %}
            <option value="{{ n }}"></option>
            {% endfor %}
          </datalist>

          {% if errors.nieruchomosc %}
          <div class="error">{{ errors.nieruchomosc }}</div>
          {% endif %}
        </div>

        <div class="field">
  <label for="segment">Segment nieruchomo≈õci</label>
  <select id="segment" name="segment">
    <option value="">(wybierz)</option>
    <option value="Detal" {% if form.segment == "Detal" %}selected{% endif %}>Detal</option>
    <option value="Hurt" {% if form.segment == "Hurt" %}selected{% endif %}>Hurt</option>
    <option value="Pozosta≈Çe" {% if form.segment == "Pozosta≈Çe" %}selected{% endif %}>Pozosta≈Çe</option>
  </select>
  <input type="hidden" id="segment-hidden" value="{{ form.segment }}">

  {% if errors.segment %}
  <div class="error">{{ errors.segment }}</div>
  {% endif %}
</div>

        {% if current_user and current_user.role == "admin" %}
        <div class="field">
          <label for="owner">W≈Ça≈õciciel (admin)</label>
          <select id="owner" name="owner">
            {% for u in all_users %}
            <option
              value="{{ u.username }}"
              {% if form.owner == u.username %}selected{% endif %}
            >
              {{ u.username }}{% if u.role == "admin" %} (admin){% endif %}
            </option>
            {% endfor %}
          </select>
          <div class="hint">Administrator mo≈ºe przepisaƒá przeglƒÖd na innego u≈ºytkownika.</div>
        </div>

        <div class="field">
          <label for="property_shared_with">Udostƒôpnij nieruchomo≈õƒá u≈ºytkownikom</label>
          <select id="property_shared_with" name="property_shared_with" multiple size="6">
            {% for u in all_users %}
              {% if u.username != form.owner %}
              <option
                value="{{ u.username }}"
                {% if u.username in form.property_shared_with %}selected{% endif %}
              >
                {{ u.username }}
              </option>
              {% endif %}
            {% endfor %}
          </select>
          <div class="hint">Przytrzymaj Ctrl/Cmd, aby wybraƒá wiele os√≥b. Dostƒôp dotyczy ca≈Çej nieruchomo≈õci.</div>
        </div>
        {% endif %}

        <div class="field">
          <label for="firma">Firma (opcjonalnie)</label>
          <input
            type="text"
            id="firma"
            name="firma"
            value="{{ form.firma }}"
            list="firma_suggestions"
            autocomplete="off"
          />
          <datalist id="firma_suggestions">
            {% for f in used_companies %}
            <option value="{{ f }}"></option>
            {% endfor %}
          </datalist>
        </div>

        <div class="field">
          <label for="telefon">Telefon (opcjonalnie)</label>
          <input
            type="tel"
            id="telefon"
            name="telefon"
            value="{{ form.telefon }}"
            autocomplete="tel"
          />
          <div class="hint">Je≈õli puste ‚Äî bƒôdzie ‚ÄûBrak danych‚Äù.</div>
        </div>

        <div class="field">
          <label for="email">E-mail (opcjonalnie)</label>
          <input
            type="email"
            id="email"
            name="email"
            value="{{ form.email }}"
            autocomplete="email"
          />
          <div class="hint">Je≈õli puste ‚Äî bƒôdzie ‚ÄûBrak danych‚Äù.</div>
        </div>

        <div class="field">
          <label for="ostatnia_data">Data ostatniego przeglƒÖdu</label>

          <div class="date-input-wrapper">
            <input
              type="text"
              id="ostatnia_data"
              name="ostatnia_data"
              value="{{ form.ostatnia_data }}"
              placeholder="DD.MM.RRRR"
              autocomplete="off"
            />
            <button type="button" class="date-picker-btn">üìÖ</button>
          </div>

          {% if errors.ostatnia_data %}
          <div class="error">{{ errors.ostatnia_data }}</div>
          {% endif %}
        </div>

        <div class="field">
          <label for="czestotliwosc_miesiace"


          
            >Czƒôstotliwo≈õƒá (w miesiƒÖcach)</label
          >
          <input
            type="number"
            id="czestotliwosc_miesiace"
            name="czestotliwosc_miesiace"
            value="{{ form.czestotliwosc_miesiace }}"
            min="1"
            step="1"
            inputmode="numeric"
          />

          {% if errors.czestotliwosc_miesiace %}
          <div class="error">{{ errors.czestotliwosc_miesiace }}</div>
          {% endif %}
        </div>

        <div class="field">
          <label for="opis">Uwagi / opis (opcjonalnie)</label>
          <textarea id="opis" name="opis" rows="3">{{ form.opis }}</textarea>
          <div class="hint">Je≈õli puste ‚Äî zapisze siƒô ‚ÄûBrak uwag‚Äù.</div>
        </div>

        <div class="actions">
          <button type="submit" class="btn btn-primary">
            {% if mode == "add" %}Zapisz przeglƒÖd{% else %}Zapisz zmiany{% endif
            %}
          </button>
          {% if return_to %}
          <a href="{{ return_to }}" class="btn">Anuluj</a>
          {% else %}
          <a href="{{ url_for('index') }}" class="btn">Anuluj</a>
          {% endif %}
          {% if mode == "edit" %}
          <button type="submit" form="deleteInspectionForm" class="btn btn-danger">Usu≈Ñ przeglƒÖd</button>
          {% endif %}
        </div>
      </form>
      {% if mode == "edit" %}
      <form
        id="deleteInspectionForm"
        method="POST"
        action="{{ url_for('delete', idx=inspection_id) }}"
        onsubmit="return confirm('Na pewno usunƒÖƒá ten przeglƒÖd?');"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        {% if return_to %}
        <input type="hidden" name="return_to" value="{{ return_to }}">
        {% endif %}
      </form>
      {% endif %}
    </div>

    <script type="application/json" id="companyContactsData">
      {{ company_contacts | tojson | safe }}
    </script>
    <script type="application/json" id="propertySegmentsData">
      {{ property_segments | tojson | safe }}
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const dateInput = document.getElementById("ostatnia_data");
        const dateBtn = document.querySelector(".date-picker-btn");
        let fp = null;

        if (dateInput) {
          fp = flatpickr(dateInput, {
            dateFormat: "Y-m-d",
            altInput: true,
            altFormat: "d.m.Y",
            allowInput: true,
            clickOpens: true,
          });
        }

        if (dateBtn && fp) {
          dateBtn.addEventListener("click", (e) => {
            e.preventDefault();
            fp.open();
          });
        }

        const rawData = document.getElementById("companyContactsData");
        const firmaInput = document.getElementById("firma");
        const telInput = document.getElementById("telefon");
        const emailInput = document.getElementById("email");

        let contacts = {};
        try {
          contacts = JSON.parse(rawData.textContent || "{}");
        } catch {}

        function autofill() {
          const data = contacts[firmaInput.value];
          if (!data) return;

          if (!telInput.value) telInput.value = data.telefon || "";
          if (!emailInput.value) emailInput.value = data.email || "";
        }

        if (firmaInput) {
          firmaInput.addEventListener("change", autofill);
          firmaInput.addEventListener("blur", autofill);
        }

        const segmentData = document.getElementById("propertySegmentsData");
        const propertyInput = document.getElementById("nieruchomosc");
        const segmentSelect = document.getElementById("segment");
        const segmentHidden = document.getElementById("segment-hidden");
        let propertySegments = {};

        try {
          propertySegments = JSON.parse(segmentData.textContent || "{}");
        } catch {}

        function normalizeKey(value) {
          return value.trim().toLowerCase().replace(/\s+/g, " ");
        }

        function lockSegment(value) {
          if (!segmentSelect || !segmentHidden) return;
          segmentSelect.value = value;
          segmentSelect.disabled = true;
          segmentHidden.name = "segment";
          segmentHidden.value = value;
        }

        function unlockSegment() {
          if (!segmentSelect || !segmentHidden) return;
          segmentSelect.disabled = false;
          segmentHidden.name = "";
          if (!segmentSelect.value) {
            segmentHidden.value = "";
          }
        }

        function applySegmentFromProperty() {
          if (!propertyInput || !segmentSelect || !segmentHidden) return;
          const key = normalizeKey(propertyInput.value || "");
          const seg = propertySegments[key] || "";
          if (seg) {
            lockSegment(seg);
          } else {
            unlockSegment();
          }
        }

        if (propertyInput) {
          propertyInput.addEventListener("change", applySegmentFromProperty);
          propertyInput.addEventListener("blur", applySegmentFromProperty);
          propertyInput.addEventListener("input", applySegmentFromProperty);
          applySegmentFromProperty();
        }
      });

      {% if current_user %}
      {% endif %}
    </script>
  </body>
</html>
