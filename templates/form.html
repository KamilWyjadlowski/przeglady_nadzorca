<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>
      {% if mode == "add" %}Dodaj przeglÄ…d{% else %}Edytuj przeglÄ…d{% endif %}
    </title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  </head>

  <body>
    <div class="container">
      <h1>Nadzorca przeglÄ…dÃ³w (wersja web)</h1>

      {% if mode == "add" %}
      <h2>Dodaj przeglÄ…d</h2>
      {% else %}
      <h2>Edytuj przeglÄ…d</h2>
      {% endif %}

      <form method="post" class="form">
        <div class="field">
          <label for="nazwa">Nazwa przeglÄ…du</label>
          <input
            type="text"
            id="nazwa"
            name="nazwa"
            value="{{ form.nazwa }}"
            list="nazwa_suggestions"
            autocomplete="off"
          />

          <datalist id="nazwa_suggestions">
            {% for n in used_names %}
            <option value="{{ n }}"></option>
            {% endfor %}
          </datalist>

          {% if errors.nazwa %}
          <div class="error">{{ errors.nazwa }}</div>
          {% endif %}
        </div>

        <div class="field">
          <label for="nieruchomosc">NieruchomoÅ›Ä‡</label>
          <input
            type="text"
            id="nieruchomosc"
            name="nieruchomosc"
            value="{{ form.nieruchomosc }}"
            list="nieruchomosci_suggestions"
            autocomplete="off"
          />

          <div class="field">
            <label for="firma">Firma (opcjonalnie)</label>
            <input
              type="text"
              id="firma"
              name="firma"
              value="{{ form.firma }}"
              list="firma_suggestions"
              autocomplete="off"
            />

            <div class="field">
              <label for="telefon">Telefon (opcjonalnie)</label>
              <input
                type="tel"
                id="telefon"
                name="telefon"
                value="{{ form.telefon }}"
                autocomplete="tel"
              />
              <div class="hint">
                JeÅ›li zostawisz puste â€“ przy wyÅ›wietlaniu bÄ™dzie â€Brak danychâ€.
              </div>
            </div>

            <div class="field">
              <label for="email">E-mail (opcjonalnie)</label>
              <input
                type="email"
                id="email"
                name="email"
                value="{{ form.email }}"
                autocomplete="email"
              />
              <div class="hint">
                JeÅ›li zostawisz puste â€“ przy wyÅ›wietlaniu bÄ™dzie â€Brak danychâ€.
              </div>
            </div>

            <datalist id="firma_suggestions">
              {% for f in used_companies %}
              <option value="{{ f }}"></option>
              {% endfor %}
            </datalist>
          </div>

          <datalist id="nieruchomosci_suggestions">
            {% for n in used_properties %}
            <option value="{{ n }}"></option>
            {% endfor %}
          </datalist>

          {% if errors.nieruchomosc %}
          <div class="error">{{ errors.nieruchomosc }}</div>
          {% endif %}
        </div>

        <div class="field">
          <label for="ostatnia_data">Data ostatniego przeglÄ…du</label>
          <div class="date-input-wrapper">
            <input
              type="text"
              id="ostatnia_data"
              name="ostatnia_data"
              value="{{ form.ostatnia_data }}"
              placeholder="DD.MM.RRRR"
              autocomplete="off"
            />

            <button type="button" class="date-picker-btn">ğŸ“…</button>
          </div>

          {% if errors.ostatnia_data %}
          <div class="error">{{ errors.ostatnia_data }}</div>
          {% endif %}
        </div>

        <div class="field">
          <label for="czestotliwosc_miesiace"
            >CzÄ™stotliwoÅ›Ä‡ (w miesiÄ…cach)</label
          >
          <input
            type="number"
            id="czestotliwosc_miesiace"
            name="czestotliwosc_miesiace"
            value="{{ form.czestotliwosc_miesiace }}"
            min="1"
            step="1"
            inputmode="numeric"
          />

          {% if errors.czestotliwosc_miesiace %}
          <div class="error">{{ errors.czestotliwosc_miesiace }}</div>
          {% endif %}
        </div>

        <div class="field">
          <label for="opis">Uwagi / opis (opcjonalnie)</label>
          <textarea id="opis" name="opis" rows="3">{{ form.opis }}</textarea>
          <div class="hint">
            JeÅ›li zostawisz puste, zapisze siÄ™ â€Brak uwagâ€.
          </div>
        </div>

        <div class="actions">
          <button type="submit" class="btn btn-primary">
            {% if mode == "add" %}Zapisz przeglÄ…d{% else %}Zapisz zmiany{% endif
            %}
          </button>
          <a href="{{ url_for('index') }}" class="btn">Anuluj</a>
        </div>
      </form>
    </div>

    <script type="application/json" id="companyContactsData">
      {{ company_contacts | tojson | safe }}
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- KALENDARZ: flatpickr ---
        const dateInput = document.getElementById("ostatnia_data");
        const dateBtn = document.querySelector(".date-picker-btn");

        let fp = null;
        if (dateInput) {
          fp = flatpickr(dateInput, {
            dateFormat: "Y-m-d", // FORMAT, KTÃ“RY IDZIE DO Pythona (wartoÅ›Ä‡ inputa)
            altInput: true, // wÅ‚Ä…cza widoczny "Å‚adny" input
            altFormat: "d.m.Y", // FORMAT, KTÃ“RY WIDZI UÅ»YTKOWNIK
            allowInput: true, // moÅ¼esz pisaÄ‡ rÄ™cznie w alt input
            clickOpens: true,
          });
        }

        // przycisk ğŸ“… otwiera kalendarz
        if (fp && dateBtn) {
          dateBtn.addEventListener("click", (e) => {
            e.preventDefault();
            fp.open();
          });
        }

        // --- FIRMA -> AUTO-UZUPEÅNIANIE KONTAKTU ---
        const companyContactsDataEl = document.getElementById(
          "companyContactsData"
        );

        let companyContacts = {};
        if (companyContactsDataEl) {
          try {
            companyContacts = JSON.parse(
              companyContactsDataEl.textContent || "{}"
            );
          } catch (e) {
            console.warn("Nie udaÅ‚o siÄ™ sparsowaÄ‡ companyContactsData:", e);
            companyContacts = {};
          }
        }

        const firmaInput = document.getElementById("firma");
        const telInput = document.getElementById("telefon");
        const emailInput = document.getElementById("email");

        function maybeFillContact() {
          if (!firmaInput) return;
          const data = companyContacts[firmaInput.value];
          if (!data) return;

          if (telInput && !telInput.value) {
            telInput.value = data.telefon || "";
          }
          if (emailInput && !emailInput.value) {
            emailInput.value = data.email || "";
          }
        }

        if (firmaInput) {
          firmaInput.addEventListener("change", maybeFillContact);
          firmaInput.addEventListener("blur", maybeFillContact);
        }
      });
    </script>
  </body>
</html>
