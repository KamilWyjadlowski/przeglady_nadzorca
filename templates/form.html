<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>
      {% if mode == "add" %}Dodaj przeglÄ…d{% else %}Edytuj przeglÄ…d{% endif %}
    </title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  </head>

  <body>
    <div class="container">
      <div class="topbar">
        <div class="brand">
          <strong>Nadzorca przeglÄ…dÃ³w</strong>
          <span class="tag">Alpha 1.0</span>
        </div>
        <div class="user-panel">
          <div class="user-name">
            Zalogowany jako <strong>{{ current_user.username if current_user else "-" }}</strong>
          </div>
          {% if current_user and current_user.role == "admin" %}
          <a href="{{ url_for('admin_properties') }}" class="btn">Panel nieruchomoÅ›ci</a>
          <a href="{{ url_for('admin_users') }}" class="btn">UÅ¼ytkownicy</a>
          {% endif %}
          <form method="POST" action="{{ url_for('logout') }}" class="logout-form">
            <button type="submit" class="btn btn-ghost">Wyloguj</button>
          </form>
        </div>
      </div>

      <h2>
        {% if mode == "add" %}Dodaj przeglÄ…d{% else %}Edytuj przeglÄ…d{% endif %}
      </h2>

      <form method="post" class="form">
        <div class="field">
          <label for="nazwa">Nazwa przeglÄ…du</label>
          <input
            type="text"
            id="nazwa"
            name="nazwa"
            value="{{ form.nazwa }}"
            list="nazwa_suggestions"
            autocomplete="off"
          />
          <datalist id="nazwa_suggestions">
            {% for n in used_names %}
            <option value="{{ n }}"></option>
            {% endfor %}
          </datalist>

          {% if errors.nazwa %}
          <div class="error">{{ errors.nazwa }}</div>
          {% endif %}
        </div>

        <div class="field">
          <label for="nieruchomosc">NieruchomoÅ›Ä‡</label>
          <input
            type="text"
            id="nieruchomosc"
            name="nieruchomosc"
            value="{{ form.nieruchomosc }}"
            list="nieruchomosci_suggestions"
            autocomplete="off"
          />
          <datalist id="nieruchomosci_suggestions">
            {% for n in used_properties %}
            <option value="{{ n }}"></option>
            {% endfor %}
          </datalist>

          {% if errors.nieruchomosc %}
          <div class="error">{{ errors.nieruchomosc }}</div>
          {% endif %}
        </div>

        <div class="field">
  <label for="segment">Segment nieruchomoÅ›ci</label>
  <select id="segment" name="segment">
    <option value="">(wybierz)</option>
    <option value="Detal" {% if form.segment == "Detal" %}selected{% endif %}>Detal</option>
    <option value="Hurt" {% if form.segment == "Hurt" %}selected{% endif %}>Hurt</option>
  </select>

  {% if errors.segment %}
  <div class="error">{{ errors.segment }}</div>
  {% endif %}
</div>

        {% if current_user and current_user.role == "admin" %}
        <div class="field">
          <label for="owner">WÅ‚aÅ›ciciel (admin)</label>
          <select id="owner" name="owner">
            {% for u in all_users %}
            <option
              value="{{ u.username }}"
              {% if form.owner == u.username %}selected{% endif %}
            >
              {{ u.username }}{% if u.role == "admin" %} (admin){% endif %}
            </option>
            {% endfor %}
          </select>
          <div class="hint">Administrator moÅ¼e przepisaÄ‡ przeglÄ…d na innego uÅ¼ytkownika.</div>
        </div>

        <div class="field">
          <label for="property_shared_with">UdostÄ™pnij nieruchomoÅ›Ä‡ uÅ¼ytkownikom</label>
          <select id="property_shared_with" name="property_shared_with" multiple size="6">
            {% for u in all_users %}
              {% if u.username != form.owner %}
              <option
                value="{{ u.username }}"
                {% if u.username in form.property_shared_with %}selected{% endif %}
              >
                {{ u.username }}
              </option>
              {% endif %}
            {% endfor %}
          </select>
          <div class="hint">Przytrzymaj Ctrl/Cmd, aby wybraÄ‡ wiele osÃ³b. DostÄ™p dotyczy caÅ‚ej nieruchomoÅ›ci.</div>
        </div>
        {% endif %}

        <div class="field">
          <label for="firma">Firma (opcjonalnie)</label>
          <input
            type="text"
            id="firma"
            name="firma"
            value="{{ form.firma }}"
            list="firma_suggestions"
            autocomplete="off"
          />
          <datalist id="firma_suggestions">
            {% for f in used_companies %}
            <option value="{{ f }}"></option>
            {% endfor %}
          </datalist>
        </div>

        <div class="field">
          <label for="telefon">Telefon (opcjonalnie)</label>
          <input
            type="tel"
            id="telefon"
            name="telefon"
            value="{{ form.telefon }}"
            autocomplete="tel"
          />
          <div class="hint">JeÅ›li puste â€” bÄ™dzie â€Brak danychâ€.</div>
        </div>

        <div class="field">
          <label for="email">E-mail (opcjonalnie)</label>
          <input
            type="email"
            id="email"
            name="email"
            value="{{ form.email }}"
            autocomplete="email"
          />
          <div class="hint">JeÅ›li puste â€” bÄ™dzie â€Brak danychâ€.</div>
        </div>

        <div class="field">
          <label for="ostatnia_data">Data ostatniego przeglÄ…du</label>

          <div class="date-input-wrapper">
            <input
              type="text"
              id="ostatnia_data"
              name="ostatnia_data"
              value="{{ form.ostatnia_data }}"
              placeholder="DD.MM.RRRR"
              autocomplete="off"
            />
            <button type="button" class="date-picker-btn">ğŸ“…</button>
          </div>

          {% if errors.ostatnia_data %}
          <div class="error">{{ errors.ostatnia_data }}</div>
          {% endif %}
        </div>

        <div class="field">
          <label for="czestotliwosc_miesiace"


          
            >CzÄ™stotliwoÅ›Ä‡ (w miesiÄ…cach)</label
          >
          <input
            type="number"
            id="czestotliwosc_miesiace"
            name="czestotliwosc_miesiace"
            value="{{ form.czestotliwosc_miesiace }}"
            min="1"
            step="1"
            inputmode="numeric"
          />

          {% if errors.czestotliwosc_miesiace %}
          <div class="error">{{ errors.czestotliwosc_miesiace }}</div>
          {% endif %}
        </div>

        <div class="field">
          <label for="opis">Uwagi / opis (opcjonalnie)</label>
          <textarea id="opis" name="opis" rows="3">{{ form.opis }}</textarea>
          <div class="hint">JeÅ›li puste â€” zapisze siÄ™ â€Brak uwagâ€.</div>
        </div>

        <div class="actions">
          <button type="submit" class="btn btn-primary">
            {% if mode == "add" %}Zapisz przeglÄ…d{% else %}Zapisz zmiany{% endif
            %}
          </button>
          <a href="{{ url_for('index') }}" class="btn">Anuluj</a>
        </div>
      </form>
    </div>

    <script type="application/json" id="companyContactsData">
      {{ company_contacts | tojson | safe }}
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const dateInput = document.getElementById("ostatnia_data");
        const dateBtn = document.querySelector(".date-picker-btn");
        let fp = null;

        if (dateInput) {
          fp = flatpickr(dateInput, {
            dateFormat: "Y-m-d",
            altInput: true,
            altFormat: "d.m.Y",
            allowInput: true,
            clickOpens: true,
          });
        }

        if (dateBtn && fp) {
          dateBtn.addEventListener("click", (e) => {
            e.preventDefault();
            fp.open();
          });
        }

        const rawData = document.getElementById("companyContactsData");
        const firmaInput = document.getElementById("firma");
        const telInput = document.getElementById("telefon");
        const emailInput = document.getElementById("email");

        let contacts = {};
        try {
          contacts = JSON.parse(rawData.textContent || "{}");
        } catch {}

        function autofill() {
          const data = contacts[firmaInput.value];
          if (!data) return;

          if (!telInput.value) telInput.value = data.telefon || "";
          if (!emailInput.value) emailInput.value = data.email || "";
        }

        if (firmaInput) {
          firmaInput.addEventListener("change", autofill);
          firmaInput.addEventListener("blur", autofill);
        }
      });
    </script>
  </body>
</html>
