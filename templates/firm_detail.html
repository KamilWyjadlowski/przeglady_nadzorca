<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>{{ firm.name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <div class="container">
      <div class="topbar">
        <div class="brand">
          <div class="brand-title">Nadzorca przeglądów <span class="brand-version">{{ app_version }}</span></div>
        </div>
        <div class="user-panel">
          <a class="user-name user-link" href="{{ url_for('profile') }}">
            Zalogowany jako: <strong>{{ current_user.username if current_user else "-" }}</strong>
          </a>
          <form method="POST" action="{{ url_for('logout') }}" class="logout-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit" class="btn btn-ghost">Wyloguj</button>
          </form>
        </div>
      </div>

      <div class="nav-split">
        <div class="nav-left">
          <a class="nav-pill" href="{{ url_for('index') }}">Przeglądy</a>
          {% if current_user and current_user.role == "admin" %}
          <details class="app-nav-dropdown">
            <summary class="nav-pill">Admin</summary>
            <div class="app-nav-menu">
              <a class="app-nav-menu-link" href="{{ url_for('admin_properties') }}">Panel nieruchomości</a>
              <a class="app-nav-menu-link" href="{{ url_for('admin_users') }}">Użytkownicy</a>
              <a class="app-nav-menu-link" href="{{ url_for('admin_notifications') }}">Powiadomienia</a>
            </div>
          </details>
          {% endif %}
        </div>
        <div class="nav-right">
          <a class="nav-pill is-active" href="{{ url_for('firm_index') }}">Firmy</a>
        </div>
      </div>

      <div class="firm-detail-top">
        {% if return_to %}
        <a href="{{ return_to }}" class="btn btn-ghost">← Lista firm</a>
        {% else %}
        <a href="{{ url_for('firm_index') }}" class="btn btn-ghost">← Lista firm</a>
        {% endif %}
      </div>

      <div class="firm-detail-header">
        <div>
          <h2>{{ firm.name }}</h2>
          <div class="firm-summary">
            {{ firm.contact_count }} kontaktów - {{ firm.property_count }} nieruchomości - {{ firm.scope_count }} zakresów
          </div>
        </div>
      </div>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-stack">
          {% for category, message in messages %}
          <div class="flash {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
        {% endif %}
      {% endwith %}

      <div class="firm-contact-list">
        {% for contact in firm.contacts %}
        <div class="firm-contact-card">
          <div class="firm-contact-header">
            <div class="firm-contact-title">
              <div class="firm-contact-main">
                <span class="firm-contact-value">{{ contact.phone or "Brak telefonu" }}</span>
                <span class="firm-contact-sep">•</span>
                {% if contact.email %}
                <a class="firm-contact-link" href="mailto:{{ contact.email }}">{{ contact.email }}</a>
                {% else %}
                <span class="firm-contact-muted">Brak email</span>
                {% endif %}
              </div>
              {% if contact.notes %}
              <div class="firm-contact-notes">{{ contact.notes }}</div>
              {% endif %}
            </div>
            <div class="firm-contact-actions">
              {% if edit_contact_id == contact.id %}
              <a class="icon-action" href="{{ url_for('firm_detail', company=firm.name) }}" title="Anuluj" aria-label="Anuluj">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M18 6L6 18M6 6l12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
              </a>
              {% else %}
              <a class="icon-action" href="{{ url_for('firm_detail', company=firm.name, edit=contact.id) }}" title="Edytuj" aria-label="Edytuj">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M4 17.5V20h2.5l9.2-9.2-2.5-2.5L4 17.5zm12-10.7 2.5 2.5 1.4-1.4a1 1 0 0 0 0-1.4l-1.1-1.1a1 1 0 0 0-1.4 0l-1.4 1.4z" fill="currentColor" />
                </svg>
              </a>
              {% endif %}
              <form method="POST" action="{{ url_for('firm_contact_delete', company=firm.name, contact_id=contact.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button type="submit" class="icon-action icon-action--danger" title="Usuń kontakt" aria-label="Usuń kontakt">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M7 7h10l-1 12H8L7 7zm2-3h6l1 2H8l1-2z" fill="currentColor" />
                  </svg>
                </button>
              </form>
              <button type="button" class="icon-action" data-toggle="assign-{{ contact.id }}" title="Dodaj przypisanie" aria-label="Dodaj przypisanie">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 5v14M5 12h14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
              </button>
            </div>
          </div>

          {% if edit_contact_id == contact.id %}
          <form method="POST" action="{{ url_for('firm_contact_update', company=firm.name, contact_id=contact.id) }}" class="firm-contact-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <div class="firm-form-grid">
              <div class="firm-field">
                <label>Telefon</label>
                <input type="text" name="phone" value="{{ contact.phone }}">
              </div>
              <div class="firm-field">
                <label>Email</label>
                <input type="email" name="email" value="{{ contact.email }}">
              </div>
              <div class="firm-field firm-field-wide">
                <label>Uwagi</label>
                <input type="text" name="notes" value="{{ contact.notes }}">
              </div>
            </div>
            <div class="firm-form-actions">
              <button type="submit" class="btn btn-primary">Zapisz</button>
            </div>
          </form>
          {% endif %}

          <div class="firm-contact-properties">
            {% if contact.properties %}
            <div class="assignment-chips">
              {% for prop in contact.properties %}
                {% for item in prop.assignments %}
                <form
                  method="POST"
                  action="{{ url_for('firm_assignment_delete', company=firm.name, contact_id=contact.id, assignment_id=item.id) }}"
                  class="assignment-chip"
                >
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                  <span>{{ prop.name | format_property }} — {{ item.scope or "Brak zakresu" }}</span>
                  <button type="submit" class="chip-remove" aria-label="Usuń przypisanie">x</button>
                </form>
                {% endfor %}
              {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">Brak przypisań do nieruchomości.</div>
            {% endif %}
          </div>

          <div class="assign-form" id="assign-{{ contact.id }}" hidden>
            <form method="POST" action="{{ url_for('firm_assignment_add', company=firm.name, contact_id=contact.id) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
              <div class="firm-form-grid">
                <div class="firm-field">
                  <label>Nieruchomość</label>
                  <select name="property_name" required>
                    <option value="">Wybierz</option>
                    {% for prop in used_properties %}
                    <option value="{{ prop }}">{{ prop | format_property }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="firm-field">
                  <label>Zakres</label>
                  <select name="scope">
                    <option value="">Wybierz</option>
                    {% for scope in used_scopes %}
                    <option value="{{ scope }}">{{ scope }}</option>
                    {% endfor %}
                  </select>
                  <input type="text" name="scope_custom" placeholder="Inny zakres (opcjonalnie)">
                </div>
              </div>
              <div class="firm-form-actions">
                <button type="submit" class="btn btn-primary">Zapisz przypisanie</button>
              </div>
            </form>
          </div>
        </div>
        {% endfor %}
        {% if not firm.contacts %}
        <div class="empty-state">Brak kontaktów dla tej firmy.</div>
        {% endif %}
      </div>

      <div class="firm-add-card">
        <h3>Dodaj kontakt</h3>
        <form method="POST" action="{{ url_for('firm_contact_add', company=firm.name) }}" class="firm-contact-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <input type="hidden" name="company_name" value="{{ firm.name }}">
          <div class="firm-form-grid">
            <div class="firm-field">
              <label>Telefon (opcjonalnie)</label>
              <input type="text" name="phone" placeholder="+48 600 000 000">
            </div>
            <div class="firm-field">
              <label>Email (opcjonalnie)</label>
              <input type="email" name="email" placeholder="kontakt@firma.pl">
            </div>
            <div class="firm-field">
              <label>Nieruchomość</label>
              <select name="property_name" required>
                <option value="">Wybierz</option>
                {% for prop in used_properties %}
                <option value="{{ prop }}">{{ prop | format_property }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="firm-field">
              <label>Zakres</label>
              <select name="scope">
                <option value="">Wybierz</option>
                {% for scope in used_scopes %}
                <option value="{{ scope }}">{{ scope }}</option>
                {% endfor %}
              </select>
              <input type="text" name="scope_custom" placeholder="Inny zakres (opcjonalnie)">
            </div>
            <div class="firm-field firm-field-wide">
              <label>Uwagi (opcjonalnie)</label>
              <input type="text" name="notes" placeholder="np. dyżury weekendowe, preferowany kontakt SMS">
            </div>
          </div>
          <div class="firm-form-actions">
            <button type="submit" class="btn btn-primary">Dodaj kontakt</button>
          </div>
        </form>
      </div>
    </div>
    <script>
      document.querySelectorAll("[data-toggle]").forEach((button) => {
        button.addEventListener("click", () => {
          const target = document.getElementById(button.dataset.toggle);
          if (!target) return;
          const isHidden = target.hasAttribute("hidden");
          document.querySelectorAll(".assign-form").forEach((form) => {
            form.setAttribute("hidden", "");
          });
          if (isHidden) {
            target.removeAttribute("hidden");
          }
        });
      });
    </script>
  </body>
</html>
