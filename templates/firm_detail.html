<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>{{ firm.name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <div class="container">
      <div class="topbar">
        <div class="brand">
          <div class="brand-title">Nadzorca przeglądów <span class="brand-version">{{ app_version }}</span></div>
        </div>
        <div class="user-panel">
          <a class="user-name user-link" href="{{ url_for('profile') }}">
            Zalogowany jako: <strong>{{ current_user.username if current_user else "-" }}</strong>
          </a>
          <form method="POST" action="{{ url_for('logout') }}" class="logout-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit" class="btn btn-ghost">Wyloguj</button>
          </form>
        </div>
      </div>

      <div class="app-nav">
        <a class="app-nav-link" href="{{ url_for('index') }}">Przeglądy</a>
        <a class="app-nav-link is-active" href="{{ url_for('firm_index') }}">Firmy</a>
        {% if current_user and current_user.role == "admin" %}
        <details class="app-nav-dropdown">
          <summary class="app-nav-link">Admin</summary>
          <div class="app-nav-menu">
            <a class="app-nav-menu-link" href="{{ url_for('admin_properties') }}">Panel nieruchomości</a>
            <a class="app-nav-menu-link" href="{{ url_for('admin_users') }}">Użytkownicy</a>
            <a class="app-nav-menu-link" href="{{ url_for('admin_notifications') }}">Powiadomienia</a>
          </div>
        </details>
        {% endif %}
      </div>

      <div class="firm-detail-top">
        <a href="{{ url_for('firm_index') }}" class="btn btn-ghost">← Lista firm</a>
      </div>

      <div class="firm-detail-header">
        <div>
          <h2>{{ firm.name }}</h2>
          <div class="firm-summary">
            {{ firm.contact_count }} kontaktów - {{ firm.property_count }} nieruchomości - {{ firm.scope_count }} zakresów
          </div>
        </div>
      </div>

      <div class="firm-contact-list">
        {% for contact in firm.contacts %}
        <div class="firm-contact-card">
          <div class="firm-contact-header">
            <div class="firm-contact-title">Kontakt #{{ loop.index }}</div>
            <div class="firm-contact-actions">
              {% if edit_contact_id == contact.id %}
              <form method="POST" action="{{ url_for('firm_contact_delete', company=firm.name, contact_id=contact.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button type="submit" class="btn btn-danger">Usuń</button>
              </form>
              <a class="btn btn-ghost" href="{{ url_for('firm_detail', company=firm.name) }}">Anuluj</a>
              {% else %}
              <a class="btn btn-ghost" href="{{ url_for('firm_detail', company=firm.name, edit=contact.id) }}">Edytuj</a>
              <form method="POST" action="{{ url_for('firm_contact_delete', company=firm.name, contact_id=contact.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button type="submit" class="btn btn-danger">Usuń</button>
              </form>
              {% endif %}
            </div>
          </div>

          {% if edit_contact_id == contact.id %}
          <form method="POST" action="{{ url_for('firm_contact_update', company=firm.name, contact_id=contact.id) }}" class="firm-contact-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <div class="firm-field">
              <label>Imię i nazwisko</label>
              <input type="text" name="contact_name" value="{{ contact.name }}">
            </div>
            <div class="firm-field">
              <label>Telefon</label>
              <input type="text" name="phone" value="{{ contact.phone }}">
            </div>
            <div class="firm-field">
              <label>Email</label>
              <input type="email" name="email" value="{{ contact.email }}">
            </div>
            <div class="firm-form-actions">
              <button type="submit" class="btn btn-primary">Zapisz</button>
            </div>
          </form>
          {% else %}
          <div class="firm-contact-lines">
            <div>
              Osoba: <span class="firm-contact-text">{{ contact.name or "-" }}</span>
            </div>
            <div>
              Telefon: <span class="firm-contact-text">{{ contact.phone or "-" }}</span>
            </div>
            <div>
              Email:
              {% if contact.email %}
              <a class="firm-contact-link" href="mailto:{{ contact.email }}">{{ contact.email }}</a>
              {% else %}
              <span class="firm-contact-text">-</span>
              {% endif %}
            </div>
          </div>
          {% endif %}

          <div class="firm-contact-properties">
            {% if contact.properties %}
            {% for prop in contact.properties %}
            <div class="firm-property">
              <div class="firm-property-head">
                <a class="firm-property-link" href="{{ url_for('index', nieruchomosc=prop.name) }}">
                  {{ prop.name | format_property }}
                </a>
              </div>
              <div class="firm-tags">
                {% if prop.items %}
                  {% for item in prop.items %}
                  <form
                    method="POST"
                    action="{{ url_for('firm_assignment_delete', company=firm.name, contact_id=contact.id, assignment_id=item.id) }}"
                    class="firm-tag-form"
                  >
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <span class="firm-tag">{{ item.scope or "Brak zakresu" }}</span>
                    <button type="submit" class="firm-tag-remove" aria-label="Usuń przypisanie">x</button>
                  </form>
                  {% endfor %}
                {% else %}
                  <span class="firm-tag">Brak zakresu</span>
                {% endif %}
              </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="empty-state">Brak przypisań do nieruchomości.</div>
            {% endif %}
          </div>

          <form method="POST" action="{{ url_for('firm_assignment_add', company=firm.name, contact_id=contact.id) }}" class="firm-assign-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <div class="firm-field">
              <label>Nieruchomość</label>
              <select name="property_name" required>
                <option value="">Wybierz</option>
                {% for prop in used_properties %}
                <option value="{{ prop }}">{{ prop | format_property }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="firm-field">
              <label>Zakres</label>
              <select name="scope">
                <option value="">Wybierz</option>
                {% for scope in used_scopes %}
                <option value="{{ scope }}">{{ scope }}</option>
                {% endfor %}
              </select>
              <input type="text" name="scope_custom" placeholder="Inny zakres (opcjonalnie)">
            </div>
            <div class="firm-form-actions">
              <button type="submit" class="btn btn-primary">Dodaj przypisanie</button>
            </div>
          </form>
        </div>
        {% endfor %}
        {% if not firm.contacts %}
        <div class="empty-state">Brak kontaktów dla tej firmy.</div>
        {% endif %}
      </div>

      <div class="firm-add-card">
        <h3>Dodaj kontakt</h3>
        <form method="POST" action="{{ url_for('firm_contact_add', company=firm.name) }}" class="firm-contact-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <input type="hidden" name="company_name" value="{{ firm.name }}">
          <div class="firm-field">
            <label>Imię i nazwisko</label>
            <input type="text" name="contact_name" placeholder="np. Anna Kowalska">
          </div>
          <div class="firm-field">
            <label>Telefon</label>
            <input type="text" name="phone" placeholder="+48 600 000 000">
          </div>
          <div class="firm-field">
            <label>Email</label>
            <input type="email" name="email" placeholder="kontakt@firma.pl">
          </div>
          <div class="firm-form-actions">
            <button type="submit" class="btn btn-primary">Dodaj kontakt</button>
          </div>
        </form>
      </div>
    </div>
  </body>
</html>
